name: CI — Rust

# Runs on every push/PR that touches Rust source or Dockerfiles.
# Jobs:
#   fmt ──► clippy ──► build
#
# Does NOT run the full stack — that is handled by bench.yml (nightly).

on:
  push:
    branches: ["**"]
    paths:
      - "services/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "docker/rust/**"
  pull_request:
    branches: ["**"]
    paths:
      - "services/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "docker/rust/**"

concurrency:
  group: ci-rust-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: "1.93"

jobs:
  # ── 1. Format check ─────────────────────────────────────────────────────────
  fmt:
    name: "Format Check (rustfmt)"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust ${{ env.RUST_VERSION }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt

      - name: rustfmt check
        run: cargo fmt --all -- --check

  # ── 2. Lint ─────────────────────────────────────────────────────────────────
  clippy:
    name: "Lint (clippy)"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [fmt]
    steps:
      - uses: actions/checkout@v4

      - name: Install system build deps (for rdkafka cmake-build)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake libssl-dev pkg-config \
            libsasl2-dev libcurl4-openssl-dev

      - name: Install Rust ${{ env.RUST_VERSION }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy

      - name: Cache cargo registry + build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rust-${{ env.RUST_VERSION }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: rust-${{ env.RUST_VERSION }}-

      - name: clippy (deny warnings)
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ── 3. Build ────────────────────────────────────────────────────────────────
  build:
    name: "Build (cargo build --release)"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [clippy]
    steps:
      - uses: actions/checkout@v4

      - name: Install system build deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake libssl-dev pkg-config \
            libsasl2-dev libcurl4-openssl-dev

      - name: Install Rust ${{ env.RUST_VERSION }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo registry + build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rust-release-${{ env.RUST_VERSION }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: rust-release-${{ env.RUST_VERSION }}-

      - name: cargo build --release
        run: cargo build --release --workspace

      - name: Verify binaries exist
        run: |
          test -f target/release/app-rs     || (echo "FAIL: app-rs binary missing"     && exit 1)
          test -f target/release/keygen-rs  || (echo "FAIL: keygen-rs binary missing"  && exit 1)
          test -f target/release/ingestion-rs || (echo "FAIL: ingestion-rs binary missing" && exit 1)
          echo "OK: all three Rust binaries built successfully"

  # ── 4. Docker build smoke test ──────────────────────────────────────────────
  docker-build:
    name: "Docker Build (all 3 Rust images)"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build app-rs image
        run: |
          docker build \
            -f docker/rust/Dockerfile.app \
            -t url-shorterner-app-rs:ci \
            .

      - name: Build keygen-rs image
        run: |
          docker build \
            -f docker/rust/Dockerfile.keygen \
            -t url-shorterner-keygen-rs:ci \
            .

      - name: Build ingestion-rs image
        run: |
          docker build \
            -f docker/rust/Dockerfile.ingestion \
            -t url-shorterner-ingestion-rs:ci \
            .

      - name: Verify images exist
        run: |
          docker image inspect url-shorterner-app-rs:ci      > /dev/null
          docker image inspect url-shorterner-keygen-rs:ci   > /dev/null
          docker image inspect url-shorterner-ingestion-rs:ci > /dev/null
          echo "OK: all three Rust Docker images built successfully"
