name: CI

# Fast deterministic gate — runs on every push and pull request.
# All 4 jobs must pass for a commit to be considered green.
#
# Job order:
#   lint ──┐
#           ├──► standards-check ──► test
#   typecheck ──┘
#
# Benchmark regression is NOT here — it runs the full 15-container stack
# which is too slow and resource-intensive for shared CI runners.
# See: .github/workflows/bench.yml  (scheduled nightly + manual dispatch)

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

# Cancel in-progress runs for the same branch/PR when a new commit is pushed.
# Prevents queued stale runs from consuming runner minutes.
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── 1. Formatting ─────────────────────────────────────────────────────────
  # Checks black + isort. Must pass before any other job proceeds.
  lint:
    name: "Format Check (black + isort)"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: black + isort check (Docker)
        run: |
          docker run --rm \
            -v "$PWD":/work -w /work \
            python:3.12-slim bash -lc \
            "pip install --no-cache-dir black==24.1.1 isort==5.13.2 >/dev/null \
             && black --check . && isort --check-only ."

  # ── 2. Static type check ──────────────────────────────────────────────────
  # Runs pyright in basic mode. Must pass before standards-check proceeds.
  typecheck:
    name: "Type Check (pyright)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: pyright (Docker)
        run: |
          docker run --rm \
            -v "$PWD":/work -w /work \
            python:3.12-slim bash -lc \
            "export DEBIAN_FRONTEND=noninteractive; \
             apt-get update >/dev/null && \
             apt-get install -y --no-install-recommends libatomic1 nodejs npm >/dev/null && \
             pip install --no-cache-dir -r requirements.txt >/dev/null && \
             npm -g --silent install pyright@1.1.408 >/dev/null && \
             pyright"

  # ── 3. Coding standards check ─────────────────────────────────────────────
  # Enforces: no loose dicts, no Any, naming conventions, Pydantic patterns,
  # import hygiene, common anti-patterns (ruff rule sets B, C4, SIM, RUF, UP).
  # Runs after lint + typecheck pass.
  standards-check:
    name: "Coding Standards (ruff)"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint, typecheck]
    steps:
      - uses: actions/checkout@v4

      - name: ruff — style, patterns, anti-patterns (Docker)
        run: |
          docker run --rm \
            -v "$PWD":/work -w /work \
            python:3.12-slim bash -lc \
            "pip install --no-cache-dir ruff==0.3.0 >/dev/null && \
             ruff check . \
               --select=E,W,F,UP,B,C4,SIM,RUF \
               --ignore=B008,UP011,E501,W293 \
               --output-format=concise"

      - name: Verify no raw dict payloads at Kafka/Redis boundaries
        # Grep for the banned patterns: dict[str, object] or dict[str, Any] used
        # as function parameter types in kafka.py, service.py, worker files.
        # Pydantic models must be used instead (ClickEvent, CachedURLPayload, etc.)
        run: |
          echo "=== Checking for banned loose-dict payload patterns ==="
          BANNED=$(grep -rn \
            --include="*.py" \
            -E ":\s*dict\[str,\s*(object|Any|str \| int)\]" \
            app/ services/ scripts/ \
            | grep -v "test_" \
            | grep -v "#.*noqa" \
            | grep -v "bench_regression_check" \
            || true)
          if [ -n "$BANNED" ]; then
            echo "FAIL: Found loose dict payload types (use Pydantic models instead):"
            echo "$BANNED"
            exit 1
          fi
          echo "OK: No banned loose-dict payload patterns found."

      - name: Verify no list[list[object]] analytics rows
        run: |
          echo "=== Checking for banned list[list[object]] patterns ==="
          BANNED=$(grep -rn \
            --include="*.py" \
            -E "list\[list\[object\]\]" \
            app/ services/ \
            || true)
          if [ -n "$BANNED" ]; then
            echo "FAIL: Found list[list[object]] (use a Pydantic model row type instead):"
            echo "$BANNED"
            exit 1
          fi
          echo "OK: No banned list[list[object]] patterns found."

      - name: Verify coding standards doc is present and non-empty
        run: |
          test -s docs/coding-standards.md || \
            (echo "FAIL: docs/coding-standards.md is missing or empty" && exit 1)
          echo "OK: coding-standards.md present."

      - name: Verify benchmark baselines file is present
        run: |
          test -s docs/bench_baselines.json || \
            (echo "FAIL: docs/bench_baselines.json is missing or empty" && exit 1)
          echo "OK: bench_baselines.json present."

  # ── 4. Functional tests ───────────────────────────────────────────────────
  # Starts only the test-profile services (db-test + redis-test), then runs
  # pytest directly in a Docker container against those services.
  # Does NOT start the full 15-container stack — that would time out on free runners.
  test:
    name: "Functional Tests (pytest)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [standards-check]
    steps:
      - uses: actions/checkout@v4

      - name: Prepare environment files
        run: |
          cp .env.ci .env
          cp .env.ci .env.test

      - name: Start test dependencies (db-test + redis-test)
        run: docker compose --profile test up -d db-test redis-test

      - name: Wait for db-test and redis-test to be healthy
        run: |
          for i in $(seq 1 30); do
            DB_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' urlshortener-db-test 2>/dev/null || echo "starting")
            REDIS_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' urlshortener-redis-test 2>/dev/null || echo "starting")
            echo "db-test=$DB_HEALTH  redis-test=$REDIS_HEALTH  ($i/30)"
            if [ "$DB_HEALTH" = "healthy" ] && [ "$REDIS_HEALTH" = "healthy" ]; then
              echo "All test dependencies healthy"; break
            fi
            sleep 5
          done
          DB_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' urlshortener-db-test 2>/dev/null)
          REDIS_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' urlshortener-redis-test 2>/dev/null)
          [ "$DB_HEALTH" = "healthy" ] && [ "$REDIS_HEALTH" = "healthy" ] || \
            (echo "FAIL: Test dependencies never became healthy" && exit 1)

      - name: Run pytest (Docker)
        run: |
          # Derive the network from the running test container (works regardless of project dir name)
          NET=$(docker inspect urlshortener-db-test \
            --format '{{range $k,$v := .NetworkSettings.Networks}}{{$k}}{{end}}' 2>/dev/null | head -1)
          echo "Using network: $NET"
          docker run --rm \
            --network "$NET" \
            --env-file .env.ci \
            -e DATABASE_URL=postgresql+asyncpg://test:test@urlshortener-db-test:5432/urlshortener_test \
            -e REDIS_URL=redis://urlshortener-redis-test:6379/0 \
            -e REDIS_REPLICA_URL=redis://urlshortener-redis-test:6379/0 \
            -v "$PWD":/work -w /work \
            python:3.12-slim bash -lc \
            "pip install --no-cache-dir -r requirements.txt >/dev/null && \
             pytest tests/ -v --tb=short"

      - name: Tear down
        if: always()
        run: docker compose --profile test down -v --remove-orphans

